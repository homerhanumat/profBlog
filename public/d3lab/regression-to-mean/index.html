
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">

<head>
<title>Data and Computing - Regression to the Mean</title>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="A website built through Hugo and blogdown.">
<meta name="keywords" content="">
<meta name="author" content="Data and Computing">
<meta name="generator" content="Hugo 0.32.3" />

  



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/1.0.0/pure-min.css">


    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/1.0.0/grids-responsive-min.css">








<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">


<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<script
			  src="https://code.jquery.com/jquery-3.2.1.min.js"
			  integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
			  crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>


<link rel="stylesheet" href="../../css/tuftesque.css">
<style>
body {
  
    background-color: #fffff8;
  
}
</style>

<link rel="stylesheet" href="../../css/custom.css">



<script>

</script>


</head>

<body>
<div id="layout" class="pure-g">
<article class="pure-u-1">
<header class="brand non-home-brand" >
  <h1>
    <a href="../../">
      <span id = "blog_logo">
         <svg xmlns="http://www.w3.org/2000/svg" class="grow" width = "50px" height = "50px" viewBox="0 0 4.6 3.0" x="0px" y="15px"><title>Home</title><g data-name="Layer 1"><path d="M3.08766,1.99213c-.18811.05691-.3736.1186-.55685.18962-.07994.03095-.15816.06559-.23628.10043a2.97192,2.97192,0,0,0-.65316-.403A.78668.78668,0,0,0,.775,2.00652a.4645.4645,0,0,0-.0683.4943.57477.57477,0,0,0,.38793.32569A1.27933,1.27933,0,0,0,1.6449,2.829a2.56026,2.56026,0,0,0,.62891-.18551L2.296,2.659l.0743.05093c-.17343.08282-.34612.16759-.52378.23926A1.77391,1.77391,0,0,1,.57779,2.91551c-.02935-.01233-.06516.00408-.04207.02662a1.0404,1.0404,0,0,0,.70007.24683,1.9666,1.9666,0,0,0,1.06846-.2183c.08674-.04613.17288-.09072.25986-.13226a2.20534,2.20534,0,0,0,.67912.3085.7369.7369,0,0,0,.708-.166A.39257.39257,0,0,0,3.742,2.3428a1.43968,1.43968,0,0,0-.77917.11791c-.092.03-.1821.06493-.27119.10262q-.046-.03151-.09129-.06353a5.75518,5.75518,0,0,1,.89517-.33171.95706.95706,0,0,1,.953.20834c.00912.00921.02756-.00131.02213-.01392C4.24551,1.84154,3.54528,1.85373,3.08766,1.99213ZM1.4528,2.52977a.57188.57188,0,0,1-.38383-.06.17676.17676,0,0,1-.02013-.28964.50668.50668,0,0,1,.44764-.0257,1.65245,1.65245,0,0,1,.47362.26323A2.12767,2.12767,0,0,1,1.4528,2.52977ZM3.137,2.63224a2.623,2.623,0,0,1,.32279-.04977.41363.41363,0,0,1,.27782.03707.12548.12548,0,0,1-.02625.19235.44765.44765,0,0,1-.316.06608,1.3124,1.3124,0,0,1-.49218-.17988A2.18209,2.18209,0,0,1,3.137,2.63224Z"/></g></svg>
      </span>
      
    </a>
  </h1>
</header>



<section>
  <h1 class="content-title">
  
  <a href="../../d3lab/regression-to-mean/">Regression to the Mean</a>
  
  </h1>
  
  
  
</section>




<section><div id="instructional-app" class="section level2">
<h2>Instructional App</h2>
<p>This is a port of one of my earliest Shiny apps.</p>
</div>
<div id="the-app" class="section level2">
<h2>The App</h2>
<style>

    svg {
      padding-bottom: 16px;
    }

    .regression {
      stroke-width: 2px;
      stroke: blue;
    }

    .sdline {
      stroke-width: 2px;
      stroke: red;
      stroke-dasharray: 10, 5;
    }

    .equation {
      font-size: 12px;
      margin-top: 5px;
      text-align: center;
    }

    .axistext {
      font-size: 14px;
    }

    #selector {
      margin-left: 50px;
    }

    .kmeans {
      visibility: hidden;
    }

    .meansPlot {
      visibility: hidden;
    }

    .meanpoint {
      visibility: hidden;
    }

    .kmeans rect {
      opacity: 0.5;
    }

    .meanlevel {
      stroke-width: 3px;
      stroke: darkgreen;
    }
</style>
<p>
<label for="rho">Target Correlation: </label> <input id="rho" type="number" value="0.5" step="0.01" min="0" max="1"> <select id="selector"> <option value="noshow" selected>Do not show y-means</option> <option value="rect" selected>Show mean of moving range</option> <option value="all">Show all means</option> </select>
</p>
<p id="reference">
</p>
<p class="chart">
</p>
<div class="equation">

</div>
<div class="equation">

</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/4.9.1/d3.min.js"></script>
<script>
  // modified just a bit from:
  // https://gist.github.com/soykje/ec2fc326830355104c89cd50bf1fa192

function responsivefy(svg) {
  // get container + svg aspect ratio
  var container = d3.select(svg.node().parentNode),
      width = parseInt(svg.attr("data-width")),
      height = parseInt(svg.attr("data-height")),
      aspect = width / height;

  // add viewBox and preserveAspectRatio properties,
  // and call resize so that svg resizes on inital page load
  svg.attr("viewBox", "0 0 " + width + " " + height)
      .attr("preserveAspectRatio", "xMinYMid")
      .call(resize);

  // to register multiple listeners for same event type,
  // you need to add namespace, i.e., 'click.foo'
  // necessary if you call invoke this function for multiple svgs
  // api docs: https://github.com/mbostock/d3/wiki/Selections#on
  d3.select(window).on("resize." + container.attr("id"), resize);

  // get width of container and resize svg to fit it
  function resize() {
  console.log(container);
      //var targetWidth = parseInt(container.style("width"));
      var targetWidth = document.querySelector("#reference").offsetWidth;
      svg.attr("width", targetWidth);
      svg.attr("height", Math.round(targetWidth / aspect));
  }
}
</script>
<script>
    // started from 
    //:http://blockbuilder.org/uredkar/e87f0cf2925cd5a78ba919bf7a279e1d
    // setup   

    let margin = { top: 33, right: 5, bottom: 20, left: 50 },
      width = 450 - margin.left - margin.right,
      height = 450 - margin.top - margin.bottom;


    document.querySelector("#selector")
      .addEventListener("input", selectHandler);

    document.querySelector("#rho")
      .addEventListener("input", rhoHandler);

    document.querySelector("#rho").dispatchEvent(new Event('input'));

    /// FUNCTIONS..................................................

    function rhoHandler(e) {
      let rho = this.value;
      let data = bvn(n = 500, rho = rho);

      document.querySelector(".chart").innerHTML = "";
      document.querySelector("#selector").value = "noshow";

      let svg = d3.select(".chart").append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
        .attr("data-width", width + margin.left + margin.right)
        .attr("data-height", height + margin.top + margin.bottom)
        .append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

      let x = d3.scaleLinear()
        .range([0, width]);

      let y = d3.scaleLinear()
        .range([height, 0]);

      let xAxis = d3.axisBottom()
        .scale(x);

      let yAxis = d3.axisLeft()
        .scale(y);

      // axis title variables     
      let yaxistext = "y"
      let xaxistext = "x"

      // text label for the x axis
      svg.append("text")
        .attr("class", "axistext")
        .attr("transform",
          "translate(" + (width - margin.left) + " ," +
          (height + margin.top) + ")")
        .style("text-anchor", "middle")
        .text(xaxistext);

      // text label for the y axis
      svg.append("text")
        .attr("class", "axistext")
        .attr("transform", "rotate(-90)")
        .attr("y", 0 - margin.left)
        .attr("x", 0 - (height / 2))
        .attr("dy", "1em")
        .style("text-anchor", "middle")
        .text(yaxistext)

      // add basic axes, all points, calculate scales     
      y.domain(d3.extent(data, function (d) { return d.y }));
      x.domain(d3.extent(data, function (d) { return d.x }));
      svg.append("g")
        .attr("class", "x axis")
        .attr("transform", "translate(0," + height + ")")
        .call(xAxis)
      svg.append("g")
        .attr("class", "y axis")
        .call(yAxis);
      svg.selectAll(".point")
        .data(data)
        .enter().append("circle")
        .attr("class", "point")
        .attr("r", 2)
        .attr("cy", function (d) { return y(d.y); })
        .attr("cx", function (d) { return x(d.x); })
        ;

      //  r, slope, regression ans sd lines
      let xSeries = data.map(function (e) { return e.x; });
      let ySeries = data.map(function (e) { return e.y; });
      let {slope, intercept, rSquare, 
        xBar, yBar, sdRatio} = leastSquares(xSeries, ySeries);
      // regression line equation
      document.getElementsByClassName("equation")[0]
        .innerHTML = "y = " + round(slope, 2) + "x + " + round(intercept, 2);
      // r
      document.getElementsByClassName("equation")[1]
        .innerHTML = "r = " + round(Math.sqrt(rSquare), 2);
      // Add trendline
      let ptAx = d3.min(xSeries);
      let ptAy = slope * d3.min(xSeries) + intercept;
      let ptBx = d3.max(xSeries);
      let ptBy = intercept + slope * d3.max(xSeries);;
      svg.append("line")
        .attr("class", "regression")
        .attr("x1", x(ptAx))
        .attr("y1", y(ptAy))
        .attr("x2", x(ptBx))
        .attr("y2", y(ptBy))
        ;
      var ptsdAX = d3.min(xSeries);
      var ptsdAY = yBar + sdRatio * (ptsdAX - xBar);
      var ptsdBX = d3.max(xSeries);
      var ptsdBY = yBar + sdRatio * (ptsdBX - xBar);

      svg.append("line")
        .attr("class", "sdline")
        .attr("x1", x(ptsdAX))
        .attr("y1", y(ptsdAY))
        .attr("x2", x(ptsdBX))
        .attr("y2", y(ptsdBY))
        ;

      svg.append("g")
        .attr("class", "kmeans")
        .attr("transform", `translate(${x(xBar) - 20}, 0)`)
        ;
      let kmeans = d3.select("g.kmeans");
      kmeans.append("rect")
        .attr("x", 0)
        .attr("y", 0)
        .attr("width", 40)
        .attr("height", height)
        .attr("fill", "palegreen")
        ;
      kmeans.append("line")
        .attr("class", "meanlevel")
        .attr("x1", 0)
        .attr("x2", 40)
        .attr("y1", y(yBar))
        .attr("y2", y(yBar))
        ;
      kmeans.append("circle")
        .attr("class", "meanpoint")
        .attr("r", 4)
        .attr("fill", "darkgreen")
        .attr("cx", 20)
        .attr("cy", y(yBar))
        ;

      const dragHandler = d3.drag().on("drag", function () {
        if (d3.event.x >= 0 && d3.event.x <= width - 40) {
          d3.select(this)
            .attr("transform", `translate(${d3.event.x}, 0)`);
          let mean = meanInRange(data, x.invert(d3.event.x),
            x.invert(d3.event.x + 40));
          let line = d3.select(".meanlevel");
          let meanPoint = d3.select(".meanpoint");
          if (isNaN(mean)) {
            line.style("visibility", "hidden");
            meanPoint.style("visibility", "hidden");
          } else {
            line.attr("y1", y(mean)).attr("y2", y(mean));
            meanPoint.attr("cy", y(mean));
            line.style("visibility", "visible");
            meanPoint.style("visibility", "visible");
          }
        }
        
      });

      dragHandler(kmeans);
      
      // make line graph of kmeans
      let bandWidth = 0.2;
      let step = (d3.max(xSeries) - d3.min(xSeries)) / 200;
      let xvals = d3.range(d3.min(xSeries), d3.max(xSeries), step);
      let pathPoints = [];
      for (let i = 0; i < xvals.length; i++) {
        let mean = meanInRange(data, xvals[i] - bandWidth,
            xvals[i] + bandWidth);
        if (!isNaN(mean)) {
          pathPoints.push({x: xvals[i], y: mean});
        }
      }
      let line = d3.line()
        .x(function(d) { return x(d.x); })
        .y(function(d) { return y(d.y); });
      svg.append("path")
      .datum(pathPoints)
      .attr("class", "meansPlot")
      .attr("fill", "none")
      .attr("stroke", "darkgray")
      .attr("stroke-linejoin", "round")
      .attr("stroke-linecap", "round")
      .attr("stroke-width", 2.0)
      .attr("d", line)
      ;
      
      responsivefy(d3.select(".chart svg"));

    }

    function gaussian(a, b) {
      return {
        u: Math.sqrt(-2 * Math.log(a)) * Math.cos(2 * Math.PI * b),
        v: Math.sqrt(-2 * Math.log(a)) * Math.sin(2 * Math.PI * b)
      };
    }

    function bvn(n = 200, rho = 0.5, mu1 = 0, sigma1 = 1,
      mu2 = 0, sigma2 = 1) {
      let data = [];
      for (let i = 0; i < n; i++) {
        //generate two independent normals (box-muller)
        let u1 = Math.random();
        let u2 = Math.random();
        let { u, v } = gaussian(u1, u2);
        let x = mu1 + sigma1 * u;
        let sdY = Math.sqrt((1 - Math.pow(rho, 2)) * Math.pow(sigma2, 2));
        let y = mu2 + (sigma2 / sigma1) * rho * (u - mu1) + sdY * v;
        data.push({ x: x, y: y });
      }
      return data;
    }

    function selectHandler(e) {
      let selection = this.value;
      if (selection === "noshow") {
        d3.select(".kmeans").style("visibility", "hidden");
        d3.select(".meanlevel").style("visibility", "hidden");
        d3.select(".meanpoint").style("visibility", "hidden");
        d3.select(".meansPlot").style("visibility", "hidden");
      }
      if (selection === "rect") {
        d3.select(".kmeans").style("visibility", "visible");
        d3.select(".meanlevel").style("visibility", "visible");
        d3.select(".meanpoint").style("visibility", "visible");
        d3.select(".meansPlot").style("visibility", "hidden");
      }
      if (selection === "all") {
        d3.select(".kmeans").style("visibility", "hidden");
        d3.select(".meanlevel").style("visibility", "hidden");
        d3.select(".meanpoint").style("visibility", "hidden");
        d3.select(".meansPlot").style("visibility", "visible");
      }
    }

    function meanInRange(data, a, b) {
      let sum = 0;
      let count = 0;
      for (let i = 0; i < data.length; i++) {
        let x = data[i].x;
        if (x >= a && x <= b) {
          sum += data[i].y
          count++
        }
      }
      return (sum / count);
    }


    // round decimals   
    function round(value, decimals) {
      return Number(Math.round(value + 'e' + decimals) + 'e-' + decimals);
    }


    // calculate linear regression
    function leastSquares(xSeries, ySeries) {

      let reduceSumFunc = function (prev, cur) { return prev + cur; }
      let xBar = xSeries.reduce(reduceSumFunc) * 1.0 / xSeries.length;
      let yBar = ySeries.reduce(reduceSumFunc) * 1.0 / ySeries.length;
      let ssXX = xSeries.map(function (d) { return Math.pow(d - xBar, 2); })
        .reduce(reduceSumFunc);

      let ssYY = ySeries.map(function (d) { return Math.pow(d - yBar, 2); })
        .reduce(reduceSumFunc);

      let sdRatio = Math.sqrt(ssYY / ssXX);

      let ssXY = xSeries.map(function (d, i) { return (d - xBar) * (ySeries[i] - yBar); })
        .reduce(reduceSumFunc);

      let slope = ssXY / ssXX;
      let intercept = yBar - (xBar * slope);
      let rSquare = Math.pow(ssXY, 2) / (ssXX * ssYY);

      return {slope, intercept, rSquare, xBar, yBar, sdRatio};
    }


  </script>
</div>
</section>
<section>
  


  
  <footer class="page-footer">
		<hr>
		<ul class="page-footer-menu">
		
		</ul>

  

	<div class="copyright">
	<p>
    
      &copy;2018
    Homer White.
    All rights reserved.
    
  </p>
  </div>
  <script type="text/x-mathjax-config">
MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [['$','$'], ['\\(','\\)']],
    displayMath: [['$$','$$'], ['\\[','\\]']],
    processEscapes: true,
    processEnvironments: true,
    menuSettings: { zoom: "Double-Click" },
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
    TeX: { equationNumbers: { autoNumber: "AMS" },
         extensions: ["AMSmath.js", "AMSsymbols.js"] }
  }
});
</script>

<script type="text/javascript"
  src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>

</footer>

</section>
</article>
</div>
</body>
</html>
